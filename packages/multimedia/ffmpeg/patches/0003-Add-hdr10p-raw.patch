From 66ed528902dd83bde5fd251ac6cf0478f65f8f69 Mon Sep 17 00:00:00 2001
From: Portisch <hugo.portisch@yahoo.de>
Date: Thu, 15 May 2025 12:38:05 +0200
Subject: [PATCH] Add hdr10p raw

---
 libavcodec/decode.c       |  1 +
 libavcodec/packet.c       |  1 +
 libavcodec/packet.h       |  5 +++++
 libavformat/matroskadec.c | 10 +++++++++-
 4 files changed, 16 insertions(+), 1 deletion(-)

diff --git a/libavcodec/decode.c b/libavcodec/decode.c
index 148af71..5364a28 100644
--- a/libavcodec/decode.c
+++ b/libavcodec/decode.c
@@ -1515,6 +1515,7 @@ int ff_decode_frame_props_from_pkt(const AVCodecContext *avctx,
         { AV_PKT_DATA_A53_CC,                     AV_FRAME_DATA_A53_CC },
         { AV_PKT_DATA_AFD,                        AV_FRAME_DATA_AFD },
         { AV_PKT_DATA_DYNAMIC_HDR10_PLUS,         AV_FRAME_DATA_DYNAMIC_HDR_PLUS },
+        { AV_PKT_DATA_DYNAMIC_HDR10_PLUS_RAW,     AV_FRAME_DATA_DYNAMIC_HDR_PLUS },
         { AV_PKT_DATA_S12M_TIMECODE,              AV_FRAME_DATA_S12M_TIMECODE },
         { AV_PKT_DATA_SKIP_SAMPLES,               AV_FRAME_DATA_SKIP_SAMPLES },
         { AV_PKT_DATA_LCEVC,                      AV_FRAME_DATA_LCEVC },
diff --git a/libavcodec/packet.c b/libavcodec/packet.c
index 381001f..8603d4e 100644
--- a/libavcodec/packet.c
+++ b/libavcodec/packet.c
@@ -301,6 +301,7 @@ const char *av_packet_side_data_name(enum AVPacketSideDataType type)
     case AV_PKT_DATA_DOVI_CONF:                  return "DOVI configuration record";
     case AV_PKT_DATA_S12M_TIMECODE:              return "SMPTE ST 12-1:2014 timecode";
     case AV_PKT_DATA_DYNAMIC_HDR10_PLUS:         return "HDR10+ Dynamic Metadata (SMPTE 2094-40)";
+    case AV_PKT_DATA_DYNAMIC_HDR10_PLUS_RAW:     return "RAW HDR10+ Dynamic Metadata (SMPTE 2094-40)";
     case AV_PKT_DATA_AMBIENT_VIEWING_ENVIRONMENT:return "Ambient viewing environment";
     case AV_PKT_DATA_IAMF_MIX_GAIN_PARAM:        return "IAMF Mix Gain Parameter Data";
     case AV_PKT_DATA_IAMF_DEMIXING_INFO_PARAM:   return "IAMF Demixing Info Parameter Data";
diff --git a/libavcodec/packet.h b/libavcodec/packet.h
index 0a28010..8274b5d 100644
--- a/libavcodec/packet.h
+++ b/libavcodec/packet.h
@@ -295,6 +295,11 @@ enum AVPacketSideDataType {
      */
     AV_PKT_DATA_DYNAMIC_HDR10_PLUS,
 
+    /**
+     * HDR10+ dynamic metadata associated with a video frame. The metadata is raw form
+     */
+    AV_PKT_DATA_DYNAMIC_HDR10_PLUS_RAW,
+
     /**
      * IAMF Mix Gain Parameter Data associated with the audio frame. This metadata
      * is in the form of the AVIAMFParamDefinition struct and contains information
diff --git a/libavformat/matroskadec.c b/libavformat/matroskadec.c
index efa3e44..53abcfd 100644
--- a/libavformat/matroskadec.c
+++ b/libavformat/matroskadec.c
@@ -3944,11 +3944,19 @@ static int matroska_parse_block_additional(MatroskaDemuxContext *matroska,
         if ((res = av_dynamic_hdr_plus_from_t35(hdrplus, bc.buffer,
                                                 bytestream2_get_bytes_left(&bc))) < 0 ||
             (res = av_packet_add_side_data(pkt, AV_PKT_DATA_DYNAMIC_HDR10_PLUS,
-                                           (uint8_t *)hdrplus, hdrplus_size)) < 0) {
+                                           (uint8_t *)hdrplus, hdrplus_size)) < 0 ||
+            (side_data = av_packet_new_side_data(pkt, AV_PKT_DATA_DYNAMIC_HDR10_PLUS_RAW,
+                                                 size)) == NULL) {
             av_free(hdrplus);
+
+            if (!side_data)
+                return AVERROR(ENOMEM);
+
             return res;
         }
 
+        memcpy(side_data, data, size);
+
         return 0;
     }
     default:
-- 
2.43.0

