From de08e09989cd48d80c958a43fc78a45d9120090d Mon Sep 17 00:00:00 2001
From: Portisch <hugo.portisch@yahoo.de>
Date: Fri, 8 Aug 2025 09:11:56 +0200
Subject: [PATCH] Revert "gsupplicant: Set MFP optional and key_mgmt for PSK"

This reverts commit 5e73b55e00b97e1867397258b72f0d6e5ad7d31d.
---
 gsupplicant/supplicant.c | 19 ++++++++++++++++---
 1 file changed, 16 insertions(+), 3 deletions(-)

diff --git a/gsupplicant/supplicant.c b/gsupplicant/supplicant.c
index 5e289953..f3be9e7b 100644
--- a/gsupplicant/supplicant.c
+++ b/gsupplicant/supplicant.c
@@ -4955,9 +4955,22 @@ static void add_network_security(DBusMessageIter *dict, GSupplicantSSID *ssid)
 		add_network_security_ciphers(dict, ssid);
 		break;
 	case G_SUPPLICANT_SECURITY_PSK:
-		key_mgmt = "SAE WPA-PSK WPA-PSK-SHA256";
-		ieee80211w = G_SUPPLICANT_MFP_OPTIONAL;
-		add_network_ieee80211w(dict, ssid, ieee80211w);
+		if (ssid->keymgmt & G_SUPPLICANT_KEYMGMT_SAE) {
+			if (ssid->keymgmt & G_SUPPLICANT_KEYMGMT_WPA_PSK) {
+				/*
+				 * WPA3-Personal transition mode: supports both
+				 * WPA2-Personal (PSK) and WPA3-Personal (SAE)
+				 */
+				key_mgmt = "SAE WPA-PSK";
+				ieee80211w = G_SUPPLICANT_MFP_OPTIONAL;
+			} else {
+				key_mgmt = "SAE";
+				ieee80211w = G_SUPPLICANT_MFP_REQUIRED;
+			}
+			add_network_ieee80211w(dict, ssid, ieee80211w);
+		} else {
+			key_mgmt = "WPA-PSK";
+		}
 		add_network_security_psk(dict, ssid);
 		add_network_security_ciphers(dict, ssid);
 		add_network_security_proto(dict, ssid);
-- 
2.43.0

