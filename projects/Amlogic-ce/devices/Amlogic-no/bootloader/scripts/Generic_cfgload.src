echo "Using device ${device}, number ${devnr}, partition ${partnr}, CoreELEC on eMMC: ${ce_on_emmc}"

setenv remotewakeup "0xffffffff"
setenv decode_type "0"
setenv remotewakeupmask "0xffffffff"
setenv coreelec "quiet"
setenv vout "1080p60hz"
setenv frac_rate_policy "0"
setenv consoleopt "console=tty0 no_console_suspend"

setenv rootopt "BOOT_IMAGE=kernel.img boot=LABEL=COREELEC disk=LABEL=STORAGE"
if test "${ce_on_emmc}" = "yes"; then setenv rootopt "BOOT_IMAGE=kernel.img boot=LABEL=CE_FLASH disk=FOLDER=/dev/CE_STORAGE"; fi

if fatload ${device} ${devnr}:${partnr} ${loadaddr} resolution.ini; then env import -t ${loadaddr} ${filesize}; fi
if fatload ${device} ${devnr}:${partnr} ${loadaddr} config.ini; then env import -t ${loadaddr} ${filesize}; fi

if test "${cec_func_config}" != ""; then setenv cec "hdmitx=cec${cec_func_config}"; fi
if test "${gpiopower}" != ""; then setenv gpiopower "gpiopower=${gpiopower}"; fi
if test "${kernel_hdmimode}" != ""; then setenv vout "${kernel_hdmimode}"; fi
if test "${usbpower}" != ""; then setenv usbpower "enable_system_power=${usbpower}"; fi
if test "${max_freq_cluster}" != ""; then setenv max_freq_cluster "max_freq_cluster=${max_freq_cluster}"; fi
if test "${keymap}" != ""; then setenv keymap "keymap=${keymap}"; fi
if test "${fbcon}" != ""; then setenv fbcon "fbcon=${fbcon}"; fi

if test "${mac}" = "" && test "${ethaddr}" != ""; then setenv localmac "mac=${ethaddr}"; fi
if test "${loadaddr_kernel}" != ""; then setenv loadaddr_kernel "0x02000000"; setenv loadaddr "${loadaddr_kernel}"; fi

setenv irsetup "remotewakeup=${remotewakeup} decode_type=${decode_type} remotewakeupmask=${remotewakeupmask}"
setenv displayopt "vout=${vout},dis frac_rate_policy=${frac_rate_policy} hdmitx=${hdmitx} hdr_policy=1"
setenv initargs "${rootopt} ${consoleopt} ${fbcon} ${keymap} ${max_freq_cluster} ${localmac} ${cec} ${irsetup} ${usbpower} ${gpiopower}"
setenv bootargs "${bootargs} ${initargs} ${displayopt} ${coreelec}"

fatload ${device} ${devnr}:${partnr} ${loadaddr} kernel.img
fatload ${device} ${devnr}:${partnr} ${dtb_mem_addr} dtb.img

bootm ${loadaddr}
bootm start
bootm loados
bootm prep
bootm go
